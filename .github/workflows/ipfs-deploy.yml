name: Build & Deploy to IPFS (Pinata)

on:
  push:
    branches:
      - main   # o la rama que uses para despliegue

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout del código
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) PNPM
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false 

      # 3) Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # 4) Instalar dependencias
      - name: Install dependencies
        run: pnpm install 

      # 5) Build del proyecto (debe generar la carpeta `out/`)
      - name: Build project
        run: pnpm run build

      # (Opcional) ver qué hay después del build
      - name: List files
        run: |
          echo "Contenido del repo tras el build:"
          ls -R

      # 6) Instalar jq para leer el JSON de Pinata
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 7) Subir la carpeta `out/` a IPFS como directorio "root"
      - name: Upload out folder to IPFS via Pinata
        id: upload
        env:
          PINATA_API_KEY: ${{ secrets.PINATA_API_KEY }}
          PINATA_SECRET_API_KEY: ${{ secrets.PINATA_SECRET_API_KEY }}
          PIN_NAME: ${{ secrets.PIN_NAME }}
        run: |
          if [ ! -d "out" ]; then
            echo "❌ La carpeta 'out' no existe. Asegúrate de que tu build genere 'out/'"
            exit 1
          fi

          cd out

          echo "Empaquetando archivos para Pinata..."
          FORM_ARGS=()
          # Recorremos todos los archivos y usamos la ruta relativa como filepath
          while IFS= read -r file; do
            RELPATH="${file#./}"
            FORM_ARGS+=(-F "file=@${file};filename=${RELPATH}")
          done < <(find . -type f -print)

          # OJO: aquí ya NO usamos wrapWithDirectory,
          # seguimos lo que recomienda la doc de Pinata para carpetas.
          RESPONSE=$(curl -s -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "pinata_api_key: $PINATA_API_KEY" \
            -H "pinata_secret_api_key: $PINATA_SECRET_API_KEY" \
            -F "pinataMetadata={\"name\":\"${PIN_NAME:-github-ipfs-deploy}\",\"keyvalues\":{\"repo\":\"${GITHUB_REPOSITORY}\",\"sha\":\"${GITHUB_SHA}\"}}" \
            "${FORM_ARGS[@]}")

          echo "Pinata response: $RESPONSE"

          CID=$(echo "$RESPONSE" | jq -r '.IpfsHash')

          if [ "$CID" = "null" ] || [ -z "$CID" ]; then
            echo "❌ Error obteniendo el CID de IPFS"
            exit 1
          fi

          echo "✅ Deploy OK. CID: $CID"
          echo "ipfs_cid=$CID" >> $GITHUB_OUTPUT

      # 8) Mostrar URLs de acceso
      - name: Show IPFS gateway URLs
        run: |
          echo "CID desplegado:"
          echo "${{ steps.upload.outputs.ipfs_cid }}"
          echo ""
          echo "Ábrelo así (sin /site ni nada):"
          echo "https://ipfs.io/ipfs/${{ steps.upload.outputs.ipfs_cid }}/"
          echo "https://gateway.pinata.cloud/ipfs/${{ steps.upload.outputs.ipfs_cid }}/"
