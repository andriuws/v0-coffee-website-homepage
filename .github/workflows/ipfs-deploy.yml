name: Build & Deploy to IPFS (Pinata)

on:
  push:
    branches:
      - main   # o la rama que uses para despliegue

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout del c√≥digo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) PNPM
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # 3) Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # 4) Instalar dependencias
      - name: Install dependencies
        run: pnpm install

      # 5) Build del proyecto (aseg√∫rate que genere la carpeta `out/`)
      - name: Build project
        run: pnpm run build

      # (Opcional, para debug)
      - name: List files
        run: |
          echo "Contenido del repo tras el build:"
          ls -R

      # 6) Instalar jq (para parsear el JSON de Pinata)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 7) Subir carpeta `out/` a IPFS v√≠a Pinata como directorio
      - name: Upload out folder to IPFS via Pinata
        id: upload
        env:
          PINATA_API_KEY: ${{ secrets.PINATA_API_KEY }}
          PINATA_SECRET_API_KEY: ${{ secrets.PINATA_SECRET_API_KEY }}
          PIN_NAME: ${{ secrets.PIN_NAME }}
        run: |
          if [ ! -d "out" ]; then
            echo "‚ùå La carpeta 'out' no existe. Aseg√∫rate de que tu build genere 'out/'"
            exit 1
          fi

          cd out

          echo "Empaquetando archivos para Pinata..."
          FORM_ARGS=()
          # OJO: asumimos que no tienes espacios raros en los nombres de archivos.
          while IFS= read -r file; do
            RELPATH="${file#./}"
            # üëá Aqu√≠ est√° la magia: forzamos un solo root directory "site/"
            VIRTUAL_PATH="${RELPATH}"
            FORM_ARGS+=(-F "file=@${file};filename=${VIRTUAL_PATH}")
          done < <(find . -type f -print)

          RESPONSE=$(curl -s -X POST "https://api.pinata.cloud/pinning/pinFileToIPFS" \
            -H "pinata_api_key: $PINATA_API_KEY" \
            -H "pinata_secret_api_key: $PINATA_SECRET_API_KEY" \
            -F "pinataOptions={\"wrapWithDirectory\": true}" \
            -F "pinataMetadata={\"name\":\"${PIN_NAME:-github-ipfs-deploy}\",\"keyvalues\":{\"repo\":\"${GITHUB_REPOSITORY}\",\"sha\":\"${GITHUB_SHA}\"}}" \
            "${FORM_ARGS[@]}")

          echo "Pinata response: $RESPONSE"

          CID=$(echo "$RESPONSE" | jq -r '.IpfsHash')

          if [ "$CID" = "null" ] || [ -z "$CID" ]; then
            echo "‚ùå Error obteniendo el CID de IPFS"
            exit 1
          fi

          echo "‚úÖ Deploy OK. CID: $CID"
          echo "ipfs_cid=$CID" >> $GITHUB_OUTPUT


      # 8) Mostrar URLs de acceso
      - name: Show IPFS gateway URLs
        run: |
          echo "CID desplegado:"
          echo "${{ steps.upload.outputs.ipfs_cid }}"
          echo ""
          echo "Gateways (abre el CID con / al final para servir index.html):"
          echo "https://ipfs.io/ipfs/${{ steps.upload.outputs.ipfs_cid }}/"
          echo "https://gateway.pinata.cloud/ipfs/${{ steps.upload.outputs.ipfs_cid }}/"
