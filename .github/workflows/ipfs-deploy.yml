name: Build & Deploy to IPFS (Pinata)

on:
  push:
    branches:
      - main   # o la rama que uses para despliegue

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout del c√≥digo
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2) PNPM
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
          run_install: false

      # 3) Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # 4) Instalar dependencias del proyecto
      - name: Install dependencies
        run: pnpm install

      # 5) Build del proyecto (debe generar la carpeta `out/`)
      - name: Build project
        run: pnpm run build

      # (Opcional) Debug: ver estructura despu√©s del build
      - name: List files after build
        run: |
          echo "Contenido del repo tras el build:"
          ls -R

      # 6) Instalar el SDK de Pinata (solo para este CI)
      - name: Install Pinata SDK
        run: pnpm add -D @pinata/sdk

      # 7) Subir la carpeta `out/` a IPFS usando el SDK oficial
      - name: Upload out folder to IPFS via Pinata SDK
        id: upload
        env:
          PINATA_API_KEY: ${{ secrets.PINATA_API_KEY }}
          PINATA_SECRET_API_KEY: ${{ secrets.PINATA_SECRET_API_KEY }}
          PIN_NAME: ${{ secrets.PIN_NAME }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          if [ ! -d "out" ]; then
            echo "‚ùå La carpeta 'out' no existe. Aseg√∫rate de que tu build genere 'out/'"
            exit 1
          fi

          CID=$(node << 'EOF'
          const PinataSDK = require('@pinata/sdk');
          const path = require('path');

          const apiKey = process.env.PINATA_API_KEY;
          const secretKey = process.env.PINATA_SECRET_API_KEY;

          if (!apiKey || !secretKey) {
            console.error('Missing Pinata API keys');
            process.exit(1);
          }

          // üëá AQU√ç EL CAMBIO: usar "new"
          const pinata = new PinataSDK({
            pinataApiKey: apiKey,
            pinataSecretApiKey: secretKey,
          });

          (async () => {
            try {
              const src = path.resolve('out');

              const res = await pinata.pinFromFS(src, {
                pinataMetadata: {
                  name: process.env.PIN_NAME || 'github-ipfs-deploy',
                  keyvalues: {
                    repo: process.env.GITHUB_REPOSITORY || '',
                    sha: process.env.GITHUB_SHA || '',
                  },
                },
              });

              // Imprimimos SOLO el CID para capturarlo en bash
              process.stdout.write(res.IpfsHash);
            } catch (err) {
              console.error('Error pinning folder to Pinata:', err);
              process.exit(1);
            }
          })();
          EOF
          )

          if [ -z "$CID" ]; then
            echo "‚ùå No se obtuvo CID de Pinata"
            exit 1
          fi

          echo "‚úÖ Deploy OK. CID: $CID"
          echo "ipfs_cid=$CID" >> $GITHUB_OUTPUT

      # 8) Mostrar URLs de acceso
      - name: Show IPFS gateway URLs
        run: |
          echo "CID desplegado:"
          echo "${{ steps.upload.outputs.ipfs_cid }}"
          echo ""
          echo "√Åbrelo DIRECTO as√≠ (con / al final):"
          echo "https://ipfs.io/ipfs/${{ steps.upload.outputs.ipfs_cid }}/"
          echo "https://gateway.pinata.cloud/ipfs/${{ steps.upload.outputs.ipfs_cid }}/"
